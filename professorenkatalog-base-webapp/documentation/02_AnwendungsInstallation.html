<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
	<title>RosDok - AnwendungsInstallation</title>
	<link rel="stylesheet" type="text/css" href="documentation.css">
</head>
<body>
<h1>Digibib-Anwendung RosDok installieren</h1> 

<h2>Tomcat / NginX</h2>
<h3>Verzeichnisse erstellen</h3>


	<ul class="commandline">
		<li>&gt; sudo mkdir /opt/rosdok</li>
		<li>&gt; sudo chown mcradmin:mcradmin /opt/rosdok</li>
		<li>&gt; cd /opt/rosdok</li>
	</ul>


<h3>Tomcat7 Instanz erstellen und konfigurieren</h3>
<h4>Instanz erstellen</h4>

	<ul class="commandline">
		<li>&gt; sudo tomcat7-instance-create tomcat7-instance</li>
		<li>&gt; sudo cp -r /etc/tomcat7/policy.d ./tomcat7-instance/conf/policy.d</li>
		<li>&gt; sudo chmod 775 tomcat7-instance -R</li>
		<li>&gt; sudo chgrp tomcat7 tomcat7-instance -R</li>
	</ul>
	

<h4>Ports und Proxy in <span class="filename">conf/server.xml</span> einstellen:</h4>
<div class="textfile">
&lt;Server port="8105" ...    <em>&lt;--(default: 8005)--&gt;</em>  
   &lt;Connector port="8180"     <em>&lt;--(default: 8080) --&gt;</em>   
              proxyName="rosdok.uni-rosdock.de"
               <em>&lt;!-- (Test: proxyName=”ub1vm100-app01.ub.uni-rostock.de”) --&gt;</em>
              proxyPort="80" /&gt;
               <em>&lt;!-- (Test: proxyPort=”80”)--&gt;</em><br />
</div>

<h4>Startskript erstellen</h4>

	<ul class="commandline">
		<li>&gt; sudo cp /etc/init.d/tomcat7 /etc/init.d/tomcat7_rosdok</li>
		<li>&gt; sudo vi tomcat7_rosdok </li>
		</ul>
<div class="textfile">		
&#35;Provides: tomcat7_rosdok

NAME=tomcat7_rosdok  
DESC="Tomcat servlet engine for RosDok"
DEFAULT=/opt/rosdok/tomcat7-instance/conf/default.properties  
 </div>
 
 <h4>Startskript in Run-Leveln registrieren</h4> 
	(Autostart beim nächsten Boot)
	<ul class="commandline"><li>&gt; sudo update-rc.d tomcat7_rosdok defaults</li></ul>

 
<h4>Default-Konfigurationsdatei</h4>
	<ul class="commandline"><li>&gt; sudo vi /opt/rosdok/tomcat7-instance/conf/default.properties</li></ul>
	<div class="textfile">
JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64  
CATALINA_HOME=/usr/share/tomcat7
CATALINA_BASE=/opt/rosdok/tomcat7-instance  
JAVA_OPTS="-Djava.awt.headless=true -Xmx1024M"
TOMCAT7_SECURITY=no
	</div>  

<h4>Datei-Permissions:</h4>
<ul class="commandline"><li>&gt; sudo chown tomcat7:tomcat7 /opt/rosdok/tomcat7-instance –R</li></ul>


<h3>NginX Server konfigurieren</h3>
Es sind auch mehrere Server-Konfigurationen in einer Datei möglich.

<h4>Log-Verzeichnis erstellen</h4>
		<ul class="commandline">
			<li>&gt; mkdir /opt/rosdok/log</li>
			<li>&gt; mkdir /opt/rosdok/log/nginx</li>
		</ul>

<h4>Konfigurationsdatei</h4>
	<ul class="commandline"><li>&gt; sudo vi /etc/nginx/sites-available/rosdok</li></ul>
	<div class="textfile">	  
server {  
    listen *:80;  
    server_name rosdok.uni-rostock.de;        # Test: ub1vm100-app01.ub.uni-rostock.de   
    client_max_body_size	110M;             # max file upload size
    access_log /opt/rosdok/log/nginx/rosdok.access.log combined;   
	
    # webapp    
	location / {
	    proxy_pass http://localhost:8180/;  
	}
	
	# serve static data content directly
	location /data/ {
	    alias /opt/rosdok/data/;
	    # autoindex on;   # would enable directory listing  
	} 
}

</div>

<h4>Logrotate konfigurieren</h4>
	(neue Datei in logrotate.d-Verzeichnis)
	<ul class="commandline"><li>&gt; sudo cp /etc/logrotate.d/nginx /etc/logrotate.d/digibib</li>
								 <li>&gt; sudo vi /etc/logrotate.d/digibib</li></ul>  

	<div class="textfile">	  
/opt/*/log/nginx/*.log {
        daily               # change to 'weekly' in production mode !!!  
        dateext  
        rotate 10000  
        maxage 36500  
        missingok  
        compress  
        delaycompress  
        notifempty  
        create 0755 mcradmin mcradmin  
        sharedscripts  
        prerotate
            if [ -d /etc/logrotate.d/httpd-prerotate ]; then \  
                run-parts /etc/logrotate.d/httpd-prerotate; \  
            fi \  
        endscript  
        postrotate  
            [ ! -f /run/nginx.pid ] || kill -USR1 `cat /run/nginx.pid`  
        endscript  
   }

</div>

<h4>Konfiguration einschalten</h4>

	<ul class="commandline"><li>&gt; sudo ln -s /etc/nginx/sites-available/rosdok /etc/nginx/sites-enabled/rosdok</li></ul>

<h4>Beide Server (Neu-)starten</h4>
	<ul class="commandline">
		<li>&gt; sudo service tomcat7_rosdok restart</li>
		<li>&gt; sudo service nginx restart</li>
	</ul>
	
<h3>Psi Probe</h3>
Webanwendung zum Monitoring von Tomcat Webservern (Parallele Zugriffe, Speicherverbrauch, ...)   <br />
siehe  <a href="http://psi-probe.googlecode.com/">http://psi-probe.googlecode.com/</a>
 
 <h4>Installationsanleitung</h4>
 	<ul>
 		<li>gemäß Psi-Probe Wiki</li>
 		<li>WAR-File deployen</li>
 		<li> Nutzer und Rollen in <span class="filename">tomcat7-instance/conf/tomcat_users.xml</span> eintragen<br />
 		     (Nutzer: <code>rosdok-probe</code> Passwort: <code>rsklmg3</code>)
 		</li>
  </ul>
  Tomcat Neustarten:
   <ul class="commandline"><li>&gt; sudo /etc/init.d/tomcat7_rosdok restart</li></ul>
<br />
Aufruf: <a href="http://rosdok.uni-rostock.de/probe">http://rosdok.uni-rostock.de/probe</a>

<h2>MyCoRe-Anwendung</h2>
<h3>Build-Prozess</h3>
<h4>Anpassen der Konfiguration des Buildnumber-Maven-Plugins in <span class="filename">mycore-base/pom.xml</span></h4>
<div class="textfile">	
    &lt;plugin&gt;
        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
        &lt;artifactId&gt;buildnumber-maven-plugin&lt;/artifactId&gt;
        &lt;executions&gt;
            &lt;execution&gt;
                &lt;phase&gt;validate&lt;/phase&gt;
                &lt;goals&gt;
                    &lt;goal&gt;create&lt;/goal&gt;
                &lt;/goals&gt;
            &lt;/execution&gt;
        &lt;/executions&gt;
        &lt;configuration&gt;
            &lt;doCheck&gt;false&lt;/doCheck&gt;
            &lt;doUpdate&gt;true&lt;/doUpdate&gt;
            &lt;revisionOnScmFailure&gt;0&lt;/revisionOnScmFailure&gt;
            &lt;providerImplementations&gt;
                &lt;svn&gt;javasvn&lt;/svn&gt;
            &lt;/providerImplementations&gt;
        &lt;/configuration&gt;
        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.google.code.maven-scm-provider-svnjava&lt;/groupId&gt;
                &lt;artifactId&gt;maven-scm-provider-svnjava&lt;/artifactId&gt;
                &lt;version&gt;2.0.2&lt;/version&gt;
            &lt;/dependency&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.tmatesoft.svnkit&lt;/groupId&gt;
                &lt;artifactId&gt;svnkit&lt;/artifactId&gt;
                &lt;version&gt;1.7.4-v1&lt;/version&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
        &lt;/plugin&gt;
        
</div>

<h3>MyCoRe-Anwendung kompilieren</h3>
(Entwicklungsrechner)
	<ul>
		<li>im Projekt <code>rosdok-webapp</code> in der Datei <span class="filename">mycore.properties</span> die Pfade für Linux anpassen</li>
		<li>ggf. Hibernate-Konfigurationen für MyCoRe und Worfklow-Datenbank anpassen</li>
		<li>Maven build für <code>rosdok-webapp</code> und <code>rosdok-complete</code></li>
		<li>ANT Task <code>zip4deployment</code> in <code>rosdok-complete</code> ausführen
		<li>Zip-Datei auf den Server übertragen
	</ul>

<h3>MyCoRe-Anwendung kopieren</h3>
	<ul>
		<li>Basisverzeichnis für Anwendung:  <span class="filename">/opt/rosdok/project</span></li>
		<li>Zip-Datei hier entpacken</li>
	</ul>
	
<h3>Postgres Datenbank einrichten</h3>
In Postgres können wir eine DB für alle MyCoRe Instanzen verwenden. Die eigentlichen Datenbanken können in Schemas abgelegt werden.

<h4>Konfiguration mittels pgadmin3 – GUI</h4>
Neue Datenbank anlegen (falls noch nicht vorhanden):
	<ul>
		<li>Name: <code>mycoredb</code></li>
		<li>Eigentümer: <code>mcradmin</code></li>
		<li>Kodierung: <code>UTF8</code></li>
		<li>2 Schemas anlegen: <code>rosdok</code>, <code>rosdok_workflow</code></li>
		<li>Für jedes Schema eine Sequenz anlegen
			<ul class="commandline"><li>
			&gt; CREATE SEQUENCE $SCHEMA$.hibernate_sequence<br />  
	        &nbsp;&nbsp;&nbsp;INCREMENT 1   MINVALUE 1  <br />
	        &nbsp;&nbsp;&nbsp;MAXVALUE 9223372036854775807  <br />
	        &nbsp;&nbsp;&nbsp;START 1 CACHE 1; </li>
	        <li>&gt; ALTER TABLE $SCHEMA$.hibernate_sequence OWNER TO mcradmin;</li>
	       </ul>
	   
	</ul>
<strong>Hinweis: ggf. Tabellen löschen</strong>
<ul>
	<li>Die DROP Statements können mit folgender Abfrage generiert werden:
			<ul class="commandline"><li>
			&gt; SELECT 'DROP TABLE "' || schemaname || '"."' || tablename || '" CASCADE;' 
FROM pg_tables WHERE schemaname = '$SCHEMA$';

</li></ul>
</ul>
<h4>Anwendung initialisieren</h4>
<ul class="commandline">
    <li> &gt; export ANT_OPTS="-Xms128m -Xmx256m"</li>
	<li> &gt; ant create.directories</li>
	<li> &gt; ant create.users</li>
	<li> &gt; ant create.class   <em>//(Klassifikationen)</em> </li>
	<li> &gt; ant create.workflow.database</li>
	<li> &gt; ant deploy.workflow.processdefinitions</li>
</ul>
<ul class="commandline">
    <li> &gt;  sudo chown tomcat7:tomcat7 /opt/rosdok/working_content -R</li>	
</ul>

<h4>PostgreSQL: Indexe erzeugen</h4>
siehe MyCoRe-Wiki  (Syntax analog zu HSQLDB)<br />
<a href="http://cmswiki.rrz.uni-hamburg.de/hummel/MyCoRe/Dokumentation/HowTo/DatenbankIndizes">
http://cmswiki.rrz.uni-hamburg.de/hummel/MyCoRe/Dokumentation/HowTo/DatenbankIndizes </a>
<ul class="commandline"><li>&gt; psql mycoredb -U mcradmin</li></ul>
<ul class="commandline">
	<li> &gt; CREATE INDEX RightLeft ON $SCHEMA$.MCRCATEGORY (CLASSID ASC, RIGHTVALUE ASC, LEFTVALUE ASC, INTERNALID ASC, CATEGID ASC);</li>
	<li> &gt; CREATE UNIQUE INDEX ClassLeftUnique ON $SCHEMA$.MCRCATEGORY(INTERNALID ASC, CLASSID ASC, LEFTVALUE ASC);</li>
	<li> &gt; CREATE INDEX Categories ON $SCHEMA$.MCRCATEGORYLINK(CATEGORY ASC);</li>
	<li> &gt; CREATE INDEX ObjectIDs ON $SCHEMA$.MCRCATEGORYLINK(OBJECTID ASC);</li>
	<li> &gt; analyze;</li>
	</ul> 
	
<h3>Webanwendung deployen</h3>
Als <code>ROOT.war</code> in das Verzeichnis <span class="filename">tomcat7-instance/webapps</span> kopieren
<p>
Weitere Webanwendungen (z.B. PsiProbe) können "normal" in das selbe Verzeichnis deployed werden.
</p>
<p>
Ein Symlink <code>ROOT &rarr; rosdok</code> (wie bei Tomcat6) auf eine der Anwendungen funktioniert mit Tomcat7 nicht mehr. Die Anwendung wird dann in der Standard-Konfiguration mehrmals geladen.
</p>

<h3>MyCoRe CLI starten</h3>
Um die &quot;Rechteproblematik&quot; zu umgehen, sollte die Kommandozeile als Tomcat Nutzer gestartet werden.
Sonst werden Metadaten und Inhalt, sowie die Lucene-Indexfiles unter einem anderen Benutzer angelegt und können
ggf. durch die Webananwendung nicht mehr gelesen  oder geändert werden.
 
<ul class="commandline">
	<li> &gt; cd /opt/rosdok/project/target/app</li>
	<li> &gt; sudo -u tomcat7 rlfe java -jar rosdok-cli.jar</li>
</ul>



<div style="min-height:128px;">&nbsp;</div>
</body>
</html>